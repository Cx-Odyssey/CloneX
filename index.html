<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CX Odyssey - Debug Version</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f0f23);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .debug-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .success { background: rgba(0, 255, 0, 0.2); border-color: #0f0; }
        .error { background: rgba(255, 0, 0, 0.2); border-color: #f00; }
        .info { background: rgba(0, 255, 255, 0.2); border-color: #0ff; }
        
        button {
            background: linear-gradient(135deg, #FFD700, #FF6B35);
            border: none;
            color: black;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }
        
        #gameArea {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .resource {
            display: inline-block;
            margin: 10px;
            padding: 10px 15px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            border: 1px solid #FFD700;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1 style="text-align: center; color: #FFD700;">CX Odyssey Debug</h1>
        
        <div id="debugInfo">
            <div class="status info">
                <strong>Initialization Status:</strong>
                <div id="initStatus">Starting...</div>
            </div>
            
            <div class="status info">
                <strong>Telegram WebApp:</strong>
                <div id="telegramStatus">Checking...</div>
            </div>
            
            <div class="status info">
                <strong>Backend Connection:</strong>
                <div id="backendStatus">Testing...</div>
            </div>
            
            <div class="status info">
                <strong>Ads SDK:</strong>
                <div id="adsStatus">Checking...</div>
            </div>
            
            <div class="status info">
                <strong>Console Errors:</strong>
                <div id="errorStatus">None detected</div>
            </div>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="runDiagnostics()">Run Diagnostics</button>
            <button onclick="testBackend()">Test Backend</button>
            <button onclick="startSimpleGame()">Start Simple Game</button>
        </div>
        
        <div id="gameArea">
            <h2>Simple Game Test</h2>
            <div class="resource">Energy: <span id="energy">100</span></div>
            <div class="resource">GP: <span id="gp">0</span></div>
            <br><br>
            <button onclick="mine()">Mine (+10 GP)</button>
            <button onclick="testSave()">Test Save</button>
        </div>
    </div>

    <script>
        // Simple game state for testing
        let gameState = {
            energy: 100,
            gp: 0
        };
        
        let telegramUser = null;
        
        // Initialize debug version
        function initDebug() {
            updateStatus('initStatus', 'Debug version loaded', 'success');
            
            // Check Telegram WebApp
            if (window.Telegram?.WebApp) {
                try {
                    window.Telegram.WebApp.ready();
                    window.Telegram.WebApp.expand();
                    telegramUser = window.Telegram.WebApp.initDataUnsafe?.user;
                    
                    if (telegramUser) {
                        updateStatus('telegramStatus', `Connected as ${telegramUser.first_name}`, 'success');
                    } else {
                        updateStatus('telegramStatus', 'Connected but no user data', 'info');
                    }
                } catch (e) {
                    updateStatus('telegramStatus', 'Error: ' + e.message, 'error');
                }
            } else {
                updateStatus('telegramStatus', 'Not running in Telegram (web mode)', 'info');
            }
            
            // Check for ads SDK
            if (typeof show_9891070 === 'function') {
                updateStatus('adsStatus', 'Monetag SDK loaded', 'success');
            } else {
                updateStatus('adsStatus', 'Monetag SDK not found', 'info');
            }
            
            // Capture console errors
            window.addEventListener('error', function(e) {
                updateStatus('errorStatus', e.message, 'error');
            });
        }
        
        function updateStatus(id, message, type) {
            const element = document.getElementById(id);
            element.textContent = message;
            element.parentElement.className = `status ${type}`;
        }
        
        function runDiagnostics() {
            updateStatus('initStatus', 'Running diagnostics...', 'info');
            
            // Test basic functionality
            setTimeout(() => {
                const tests = [
                    'localStorage available: ' + (typeof Storage !== "undefined"),
                    'JSON parsing works: ' + (JSON.stringify({test: true}) !== null),
                    'Math functions work: ' + (Math.random() > 0),
                    'Date functions work: ' + (new Date().getTime() > 0)
                ];
                updateStatus('initStatus', tests.join(', '), 'success');
            }, 1000);
        }
        
        async function testBackend() {
            updateStatus('backendStatus', 'Testing connection...', 'info');
            
            try {
                // Test leaderboard endpoint
                const response = await fetch('https://cx-odyssey-backend.vercel.app/api/leaderboard');
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus('backendStatus', `Connected! Found ${data.topPlayers?.length || 0} players`, 'success');
                } else {
                    updateStatus('backendStatus', `Error ${response.status}: ${data.error || 'Unknown'}`, 'error');
                }
            } catch (error) {
                updateStatus('backendStatus', 'Connection failed: ' + error.message, 'error');
            }
        }
        
        function startSimpleGame() {
            document.getElementById('gameArea').style.display = 'block';
            updateUI();
        }
        
        function mine() {
            if (gameState.energy >= 10) {
                gameState.energy -= 10;
                gameState.gp += 10;
                updateUI();
            } else {
                alert('Not enough energy!');
            }
        }
        
        async function testSave() {
            if (!telegramUser) {
                alert('No Telegram user - cannot test save');
                return;
            }
            
            try {
                const response = await fetch('https://cx-odyssey-backend.vercel.app/api/saveProgress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegramId: telegramUser.id,
                        username: telegramUser.first_name,
                        gameState: {
                            energy: gameState.energy,
                            maxEnergy: 100,
                            shards: 0,
                            gp: gameState.gp
                        }
                    })
                });
                
                const result = await response.json();
                if (response.ok) {
                    alert('Save successful!');
                } else {
                    alert('Save failed: ' + result.error);
                }
            } catch (error) {
                alert('Save error: ' + error.message);
            }
        }
        
        function updateUI() {
            document.getElementById('energy').textContent = gameState.energy;
            document.getElementById('gp').textContent = gameState.gp;
        }
        
        // Initialize when page loads
        window.addEventListener('load', initDebug);
    </script>
</body>
</html>
